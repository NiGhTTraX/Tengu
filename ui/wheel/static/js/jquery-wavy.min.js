/* jquery-wavy v1.1.2
(c) 2013, Andrei Picus
License: GPL */
$.widget("wavy.wavy",{options:{slotClass:"wavy-slot",placeholderClass:"wavy-placeholder",shiftDirection:"closest",acceptOnWavy:!0,scope:"default",path:null,offset:!1,rotate:!1},_create:function(){this.element.addClass("wavy"),this._getSize(),this._createSlots(),this._positionSlots(),this._makeSortable(),this.options.acceptOnWavy===!0&&this._makeWavyDroppable()},_getSize:function(){var a=this.options.path;if(this._size=0,null!==a)for(var b=0,c=a.length;c>b;b++)this._size+=a[b][1];else this.refresh();this._capacity=this._size},_createSlots:function(){if(null!==this.options.path)for(var a=0;a<this._size;a++){var b=$("<div></div>").addClass(this.options.slotClass);b.appendTo(this.element)}},_removeSlots:function(a){void 0===a&&(a=0),$("."+this.options.slotClass,this.element).slice(a).remove()},_destroy:function(){this.element.removeClass("wavy full"),this._removeSlots()},_setOption:function(a,b){switch(a){case"scope":this._updateScope(b)}this._super(a,b)},_updateScope:function(a){$("."+this.options.slotClass,this.element).each(function(){$(this).droppable("option","scope",a),$(this).children().each(function(){$(this).draggable("option","scope",a)})}),this.options.acceptOnWavy&&this.element.droppable("option","scope",a)},_createSelector:function(){return":not(."+this.options.placeholderClass+")"},_deg2rad:function(a){return a*Math.PI/180},_pathBezier:function(a,b,c,d,e,f,g,h,i){a=1-a;var j=1-a,k=a*a,l=j*j,m=k*a,n=3*k*j,o=3*a*l,p=l*j,q=k*(f-b)+2*j*a*(h-f)+l*(d-h),r=k*(g-c)+2*j*a*(i-g)+l*(e-i);return{x:m*b+n*f+o*h+p*d,y:m*c+n*g+o*i+p*e,angle:Math.atan2(r,q)}},_pathArc:function(a,b,c,d,e,f){var g=(f-e)*a+e;return{x:Math.cos(g)*d+b,y:Math.sin(g)*d+c,angle:g+Math.PI/2}},_pathLine:function(a,b,c,d,e){return{x:(d-b)*a+b,y:(e-c)*a+c,angle:Math.atan2(e-c,d-b)}},_positionSlots:function(){if(null!==this.options.path)for(var a=this,b=this.options.path,c=0,d=0,e=b.length;e>d;d++){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=b[d],v=u[0],w=u[1],x=0,y=0,z=0;if("bezier"===v)f=1/(w-1),h=u[2],i=u[3],j=u[4],k=u[5],l=u[6],m=u[7],n=u[8],o=u[9];else if("line"===v)f=1/(w-1),h=u[2],i=u[3],j=u[4],k=u[5];else{if("arc"!==v)throw new Error("Unknown path type");f=1/w,s=u[2],t=u[3],p=u[4],q=this._deg2rad(u[5]),r=this._deg2rad(u[6])}this.options.offset===!0&&(g=this.element.position(),y=g.left,z=g.top),$("."+this.options.slotClass,this.element).slice(c,c+w).each(function(){var b;"bezier"===v?b=a._pathBezier(x,h,i,j,k,l,m,n,o):"line"===v?b=a._pathLine(x,h,i,j,k):"arc"===v&&(b=a._pathArc(x,s,t,p,q,r)),x+=f,$(this).css({left:Math.round(b.x)-y+"px",top:Math.round(b.y)-z+"px"}),a.options.rotate===!0&&$(this).css("transform","rotate("+b.angle.toFixed(2)+"rad)")}),c+=w}},_makeSortable:function(){var a=this,b=$.wavy.wmanager,c=this._createSelector();$("."+this.options.slotClass,this.element).each(function(){$(this).droppable({scope:a.options.scope,greedy:!0,over:function(d,e){if(b.current===a||0!==a._capacity){if(b.current&&b.current!==a&&(b.placeholder.appendTo($(this)),b.current.refresh(),a._capacity-=1),b.current=a,b.placeholder?e.helper.data("index",$(this).index()):(b.placeholder=e.helper.clone(),b.placeholder.css({left:0,top:0}),b.placeholder.addClass(a.options.placeholderClass),a._capacity-=1,$(e.draggable).on("dragstop",function(){b.placeholder&&(b.placeholder.remove(),b.placeholder=null,b.current.refresh()),b.current=null})),0!==$(this).children(c).length){var f=$(this).index(),g=a._findFreeSpot(f);a._shift(f,g)}b.placeholder.appendTo($(this)),0===a._capacity&&a.element.addClass("full")}},drop:function(){return 0===a._capacity?(b.current=null,b.placeholder=null,void 0):(b.placeholder.removeClass(a.options.placeholderClass),b.current=null,b.placeholder=null,void 0)}}),$(this).children().each(function(){a._capacity-=1,a._makeItemDraggable($(this))})})},_makeWavyDroppable:function(){var a=this,b=$.wavy.wmanager;this.element.droppable({scope:this.options.scope,greedy:!0,drop:function(c,d){0!==a._capacity&&(b.current===a?(b.placeholder.removeClass(a.options.placeholderClass),a._makeItemDraggable(b.placeholder),b.placeholder=null):(b.placeholder&&(b.placeholder.remove(),b.placeholder=null,b.current.refresh()),a.addItem(d.helper.clone())),b.current=null)}})},_makeItemDraggable:function(a){var b=this,c=$.wavy.wmanager;a.css({left:0,top:0}),a.draggable({scope:b.options.scope,revert:!1,helper:"clone",appendTo:b.element,start:function(a,d){d.helper.data("index",$(this).parent().index()),$(this).addClass(b.options.placeholderClass),c.placeholder=$(this),c.current=b},stop:function(){c.placeholder&&(c.placeholder.removeClass(b.options.placeholderClass),c.placeholder=null,c.current=null)}})},_findFreeSpot:function(a){var b,c,d,e=this._size,f=this._createSelector();for(d=a+1;e>d;d++)if(!this.element.children().eq(d).children(f).length){if("right"===this.options.shiftDirection)return d;c=d;break}for(d=a-1;d>=0;d--)if(!this.element.children().eq(d).children(f).length){if("left"===this.options.shiftDirection)return d;b=d;break}if(void 0===b&&void 0===c)throw new Error("Couldn't find free spot");if(void 0===b)return c;if(void 0===c)return b;if("closest"===this.options.shiftDirection)return c-a>a-b?b:c;throw new Error("Unknown option for shiftDirection")},_shift:function(a,b){var c,d=this._createSelector();if(b>a)for(c=b;c>a;c--)this.element.children().eq(c-1).children(d).appendTo(this.element.children().eq(c));else for(c=b;a>c;c++)this.element.children().eq(c+1).children(d).appendTo(this.element.children().eq(c))},_addItem:function(a,b){this._makeItemDraggable(a),a.appendTo(b)},addItem:function(a,b){if(0===this._capacity)throw new Error("Wavy full");var c,d;void 0!==b?(c=this.element.children().eq(b),c.children().length&&(d=this._findFreeSpot(b),this._shift(b,d))):(d=this._findFreeSpot(-1),c=this.element.children().eq(d)),this._addItem(a,c),this._capacity-=1,0===this._capacity&&this.element.addClass("full")},removeItem:function(a){var b=this.element.children().eq(a),c=b.children();c.length&&(c.remove(),this._capacity+=1,this.element.removeClass("full"))},capacity:function(){return this._capacity},refresh:function(){var a=$("."+this.options.slotClass,this.element);this._size=this._capacity=a.length,a.each(function(){$(this).children().length&&this._capacity--})}}),$.wavy.wmanager={current:null,placeholder:null};